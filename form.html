<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxqmuz8OGIeATVLwpsC2xKX-8fZWjzwFch6v_Q50LiqBmXofmkw6xdUoogLgILjtdS5fQ/exec";

/* ===============================
   LOAD ASSET LIST
=============================== */
fetch(API_URL + "?mode=asset")
.then(r => r.json())
.then(list => {
  const sel = document.getElementById("asset_id");
  list.forEach(a => {
    const o = document.createElement("option");
    o.value = a;
    o.textContent = a;
    sel.appendChild(o);
  });
});

/* ===============================
   ASSET DETAIL
=============================== */
async function loadAssetDetail(assetId){
  if(!assetId){
    document.getElementById("assetDetail").style.display="none";
    return;
  }

  try{
    const res = await fetch(API_URL + "?mode=assetDetail&asset_id=" + encodeURIComponent(assetId));
    const a = await res.json();

    if(!a || a.error){
      document.getElementById("assetDetail").style.display="none";
      return;
    }

    document.getElementById("assetDetail").style.display="block";
    document.getElementById("assetImage").src = a.image_url || "";
    document.getElementById("d_name").innerText = a.asset_name || "-";
    document.getElementById("d_class").innerText = a.asset_class || "-";
    document.getElementById("d_kw").innerText = a.kw || "-";
    document.getElementById("d_hp").innerText = a.hp || "-";
    document.getElementById("d_line").innerText = a.line || "-";
    document.getElementById("d_location").innerText = a.location || "-";
    document.getElementById("d_status").innerText = a.status || "-";
  }catch(err){
    console.error(err);
  }
}

document.getElementById("asset_id").addEventListener("change", function(){
  loadAssetDetail(this.value);
});

/* ===============================
   QR SCANNER
=============================== */
let qrScanner = null;

function openQRScanner(){
  document.getElementById("qr-reader").style.display="block";
  document.getElementById("closeQR").style.display="block";

  qrScanner = new Html5Qrcode("qr-reader");
  qrScanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    txt => {
      const asset = txt.trim();
      document.getElementById("asset_id").value = asset;
      loadAssetDetail(asset);
      closeQR();
    }
  );
}

function closeQR(){
  if(qrScanner){
    qrScanner.stop().then(()=> qrScanner.clear());
    qrScanner = null;
  }
  document.getElementById("qr-reader").style.display="none";
  document.getElementById("closeQR").style.display="none";
}

/* ===============================
   PHOTO
=============================== */
let images=[];
const maxPhotos=4;

function takePhoto(){
  if(images.length>=maxPhotos){
    alert("ครบ 4 รูปแล้ว");
    return;
  }
  document.getElementById("cameraInput").click();
}

document.getElementById("cameraInput").addEventListener("change",()=>{
  const file = cameraInput.files[0];
  if(!file) return;

  const r=new FileReader();
  r.onload=()=>{
    images.push(r.result);
    const img=document.createElement("img");
    img.src=r.result;
    preview.appendChild(img);
    document.getElementById("photo-count").textContent = images.length+" / "+maxPhotos;
  };
  r.readAsDataURL(file);
});

/* ===============================
   SUBMIT
=============================== */
async function submitWO(){
  const btn=document.getElementById("submitBtn");
  if(btn.disabled) return;

  btn.disabled=true;
  btn.innerText="⏳ Sending...";

  try{
    const payload={
      asset_id:asset_id.value,
      line:line.value,
      problem:problem.value,
      priority:priority.value,
      owner:owner.value,
      email:email.value,
      phone:phone.value,
      images:images
    };

    const res=await fetch(API_URL,{
      method:"POST",
      body:JSON.stringify(payload)
    });

    const d=await res.json();
    if(d.status==="success"){
      alert("Created "+d.wo_id);
      location.reload();
    }else{
      throw d.message;
    }
  }catch(err){
    alert("Error sending data");
    console.error(err);
    btn.disabled=false;
    btn.innerText="Submit Work Order";
  }
}
</script>
