// ================================
// CONFIG
// ================================
const SPREADSHEET_ID = "1QtHgPE-WDn9ycnQGna0u-Lr4VnH318uexis3SuOIam0";
const SHEET_NAME = "WORK_ORDER";

const SLIDE_TEMPLATE_ID = "1n9agKbGrgvUSC4_KIs4G_SdB--Un05a6LHopFfB780A";
const PDF_FOLDER_ID = "1ZLWZGzFMJTcY3IerRQ-LRE9yvBqTtHGx";

const ADMIN_EMAIL = "airservicepcg@gmail.com";
const MANAGER_EMAIL = "narongkon.poo@perfectcompanion.com";

// ================================
// WEB APP ENTRY
// ================================
function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);

    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName(SHEET_NAME);

    const woId = "WO-" + Date.now();
    const now = new Date();

    // บันทึกลง Sheet
    sheet.appendRow([
      woId,
      now,
      data.asset_id,
      data.line,
      data.problem,
      data.priority,
      data.owner,
      data.email,
      data.phone,
      data.photos?.[0] || "",
      data.photos?.[1] || "",
      data.photos?.[2] || "",
      data.photos?.[3] || "",
      "OPEN"
    ]);

    // =====================
    // PDF + EMAIL (ทันที)
    // =====================
    const pdfUrl = generatePdfFromWorkOrder({
      wo_id: woId,
      date: Utilities.formatDate(now, Session.getScriptTimeZone(), "dd/MM/yyyy"),
      asset_id: data.asset_id,
      line: data.line,
      problem: data.problem,
      priority: data.priority,
      owner: data.owner,
      phone: data.phone,
      photos: data.photos || []
    });

    sendWorkOrderEmail({
      wo_id: woId,
      date: Utilities.formatDate(now, Session.getScriptTimeZone(), "dd/MM/yyyy"),
      asset_id: data.asset_id,
      line: data.line,
      problem: data.problem,
      priority: data.priority,
      email: data.email
    }, pdfUrl);

    return json({ status: "success", wo_id: woId });

  } catch (err) {
    return json({ status: "error", message: err.toString() });
  }
}

// ================================
// PDF
// ================================
function generatePdfFromWorkOrder(data) {
  const copy = DriveApp.getFileById(SLIDE_TEMPLATE_ID)
    .makeCopy(`WO_${data.wo_id}`);

  const pres = SlidesApp.openById(copy.getId());
  const slide = pres.getSlides()[0];

  slide.replaceAllText("{{WO_ID}}", data.wo_id);
  slide.replaceAllText("{{DATE}}", data.date);
  slide.replaceAllText("{{ASSET_ID}}", data.asset_id);
  slide.replaceAllText("{{LINE}}", data.line);
  slide.replaceAllText("{{PROBLEM}}", data.problem);
  slide.replaceAllText("{{PRIORITY}}", data.priority);

  let x = 40;
  data.photos.slice(0, 4).forEach(url => {
    const id = url.match(/[-\w]{25,}/);
    if (!id) return;
    slide.insertImage(
      DriveApp.getFileById(id[0]).getBlob(),
      x, 320, 120, 90
    );
    x += 130;
  });

  pres.saveAndClose();

  const pdf = copy.getBlob().setName(`WO_${data.wo_id}.pdf`);
  const pdfFile = DriveApp.getFolderById(PDF_FOLDER_ID).createFile(pdf);

  DriveApp.getFileById(copy.getId()).setTrashed(true);

  return pdfFile.getUrl();
}

// ================================
// EMAIL
// ================================
function sendWorkOrderEmail(data, pdfUrl) {
  MailApp.sendEmail({
    to: [data.email, ADMIN_EMAIL, MANAGER_EMAIL].join(","),
    subject: `แจ้งรับใบงานซ่อม ${data.wo_id}`,
    body:
`เลขที่ใบงาน : ${data.wo_id}
วันที่ : ${data.date}
Asset : ${data.asset_id}
Line : ${data.line}
ปัญหา : ${data.problem}
ความสำคัญ : ${data.priority}

PDF:
${pdfUrl}`
  });
}

// ================================
function json(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}
