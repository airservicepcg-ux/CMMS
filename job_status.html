<script>
const API_URL =
  "https://script.google.com/macros/s/AKfycbzPlxZPUvYTiiVPhum7JDbarfIfbpZ2c8_tJa7AZb4OypRJwFB171oC-UqpDdkKMdEhSA/exec";

let jobs = [];

fetch(API_URL + "?mode=jobStatus")
  .then(r => r.json())
  .then(data => {
    console.log("JOB STATUS:", data);
    jobs = Array.isArray(data) ? data : [];
    render();
  })
  .catch(() => {
    document.getElementById("tbody").innerHTML =
      `<tr><td colspan="6" class="empty">‚ùå Load failed</td></tr>`;
  });

["fWo","fAsset","fProblem","fPriority","fStatus"].forEach(id=>{
  document.getElementById(id).addEventListener("input", render);
});

function render(){
  const wo = fWo.value.toLowerCase();
  const asset = fAsset.value.toLowerCase();
  const prob = fProblem.value.toLowerCase();
  const pri = fPriority.value;
  const st = fStatus.value;

  const rows = jobs.filter(j=>{
    return (!wo || (j.wo_id||"").toLowerCase().includes(wo)) &&
           (!asset || (j.asset_id||"").toLowerCase().includes(asset)) &&
           (!prob || (j.problem||"").toLowerCase().includes(prob)) &&
           (!pri || j.priority === pri) &&
           (!st || j.status === st);
  });

  const tbody = document.getElementById("tbody");

  if(!rows.length){
    tbody.innerHTML =
      `<tr><td colspan="6" class="empty">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á</td></tr>`;
    return;
  }

  tbody.innerHTML = rows.map(j => `
    <tr>
      <td><b>${j.wo_id}</b></td>
      <td>${j.asset_id}</td>
      <td>${j.problem}</td>
      <td>${j.priority}</td>
      <td><span class="badge ${j.status}">${j.status}</span></td>
      <td>
        ${j.pdf_url
          ? `<a href="${j.pdf_url}" target="_blank" class="btn-pdf">üìÑ PDF</a>`
          : "-"
        }
      </td>
    </tr>
  `).join("");
}
</script>
