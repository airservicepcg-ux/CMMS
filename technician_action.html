<script>
const API_URL =
  "https://script.google.com/macros/s/AKfycbzPlxZPUvYTiiVPhum7JDbarfIfbpZ2c8_tJa7AZb4OypRJwFB171oC-UqpDdkKMdEhSA/exec";

const woInput = document.getElementById("woId");
const techInput = document.getElementById("technician");
const detailInput = document.getElementById("detail");
const statusMsg = document.getElementById("statusMsg");
const startBtn = document.querySelector(".start");
const finishBtn = document.querySelector(".finish");

function setStatus(msg, color="black"){
  statusMsg.textContent = msg;
  statusMsg.style.color = color;
}

function lockAll(){
  startBtn.disabled = true;
  finishBtn.disabled = true;
  techInput.disabled = true;
  detailInput.disabled = true;
}

function unlockStart(){
  startBtn.disabled = false;
  finishBtn.disabled = true;
  techInput.disabled = false;
  detailInput.disabled = false;
}

/* ===============================
 START JOB
=============================== */
async function startJob(){
  const wo = woInput.value.trim();
  const tech = techInput.value.trim();

  if(!wo || !tech){
    setStatus("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å WO ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≤‡∏á","red");
    return;
  }

  startBtn.disabled = true;

  const res = await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      mode:"technician",
      action:"START",
      wo_id:wo,
      technician:tech
    })
  }).then(r=>r.json());

  console.log(res);

  if(res.status==="ok"){
    finishBtn.disabled = false;
    setStatus("üü° ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß","#ca8a04");
  }else{
    setStatus("‚ùå "+(res.error||"Start failed"),"red");
    startBtn.disabled = false;
  }
}

/* ===============================
 FINISH JOB
=============================== */
async function finishJob(){
  const wo = woInput.value.trim();
  const detail = detailInput.value.trim();

  if(!detail){
    setStatus("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î","red");
    return;
  }

  if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?")) return;

  finishBtn.disabled = true;

  const res = await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      mode:"technician",
      action:"FINISH",
      wo_id:wo,
      detail:detail
    })
  }).then(r=>r.json());

  console.log(res);

  if(res.status==="ok"){
    lockAll();
    setStatus("‚úÖ ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢","green");
  }else{
    setStatus("‚ùå "+(res.error||"Finish failed"),"red");
    finishBtn.disabled = false;
  }
}
</script>
