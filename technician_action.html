<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>Technician Action</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  body {
    font-family: system-ui, -apple-system, sans-serif;
    background: #f4f6f9;
    margin: 0;
  }

  header {
    background: #1e3a8a;
    color: white;
    padding: 14px 20px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  header a {
    color: white;
    text-decoration: none;
    background: #2563eb;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 14px;
  }

  main {
    max-width: 520px;
    margin: 30px auto;
    background: white;
    padding: 24px;
    border-radius: 14px;
    box-shadow: 0 10px 20px rgba(0,0,0,.08);
  }

  h2 {
    margin-top: 0;
    margin-bottom: 20px;
    color: #1e3a8a;
  }

  label {
    display: block;
    margin-top: 14px;
    font-weight: 600;
  }

  input, textarea {
    width: 100%;
    padding: 10px;
    margin-top: 6px;
    border-radius: 8px;
    border: 1px solid #cbd5e1;
    font-size: 15px;
  }

  textarea {
    resize: vertical;
  }

  .actions {
    display: flex;
    gap: 12px;
    margin-top: 22px;
  }

  button {
    flex: 1;
    padding: 12px;
    font-size: 16px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    font-weight: 600;
  }

  .start {
    background: #facc15;
    color: #000;
  }

  .finish {
    background: #22c55e;
    color: white;
  }

  button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .status {
    margin-top: 16px;
    font-weight: 600;
  }
</style>
</head>

<body>

<header>
  <a href="job_status.html">‚Üê Back</a>
  <strong>üîß Technician Action</strong>
</header>

<main>
  <h2>Work Order Control</h2>

  <label>Work Order ID</label>
  <input id="woId" placeholder="WO-XXX-YYYYMMDD-001" />

  <label>Technician Name</label>
  <input id="technician" placeholder="Somchai" />

  <label>Fix Detail (Finish only)</label>
  <textarea id="detail" rows="3" placeholder="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà / ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≤‡∏¢‡πÑ‡∏ü"></textarea>

  <div class="actions">
    <button class="start" id="btnStart">‚ñ∂Ô∏è Start</button>
    <button class="finish" id="btnFinish">‚úÖ Finish</button>
  </div>

  <div id="statusMsg" class="status"></div>
</main>

<script>
/* ======================================================
 CONFIG
====================================================== */
const API_URL =
  "https://script.google.com/macros/s/AKfycbzPlxZPUvYTiiVPhum7JDbarfIfbpZ2c8_tJa7AZb4OypRJwFB171oC-UqpDdkKMdEhSA/exec";

/* ======================================================
 ELEMENTS
====================================================== */
const woInput = document.getElementById("woId");
const techInput = document.getElementById("technician");
const detailInput = document.getElementById("detail");
const statusMsg = document.getElementById("statusMsg");
const startBtn = document.getElementById("btnStart");
const finishBtn = document.getElementById("btnFinish");

/* ======================================================
 UI HELPERS
====================================================== */
function setStatus(msg, color = "black") {
  statusMsg.textContent = msg;
  statusMsg.style.color = color;
}

function lockAll() {
  techInput.disabled = true;
  detailInput.disabled = true;
  startBtn.disabled = true;
  finishBtn.disabled = true;
}

function unlockForStart() {
  techInput.disabled = false;
  detailInput.disabled = false;
  startBtn.disabled = false;
  finishBtn.disabled = true;
}

function unlockForFinish() {
  techInput.disabled = true;
  detailInput.disabled = false;
  startBtn.disabled = true;
  finishBtn.disabled = false;
}

function resetForm() {
  woInput.value = "";
  techInput.value = "";
  detailInput.value = "";
  unlockForStart();
  setStatus("");
}

/* ======================================================
 CHECK STATUS (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏Å WO)
====================================================== */
woInput.addEventListener("blur", checkStatus);

async function checkStatus() {
  const wo = woInput.value.trim();
  if (!wo) return;

  setStatus("‚è≥ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô...");

  try {
    const res = await fetch(
      `${API_URL}?mode=technician&action=CHECK_STATUS&wo_no=${encodeURIComponent(wo)}`
    ).then(r => r.json());

    if (res.status === "COMPLETED" || res.status === "FINISHED") {
      lockAll();
      setStatus("üîí ‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß", "gray");
    } 
    else if (res.status === "IN_PROGRESS") {
      unlockForFinish();
      setStatus("üü° ‡∏á‡∏≤‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£", "#ca8a04");
    } 
    else if (res.status === "OPEN" || res.status === "SENT") {
      unlockForStart();
      setStatus("üÜï ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô", "#2563eb");
    } 
    else if (res.status === "NOT_FOUND") {
      unlockForStart();
      setStatus("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Work Order", "red");
    }
    else {
      setStatus("‚ùå ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å", "red");
    }

  } catch (err) {
    setStatus("‚ùå ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "red");
  }
}

/* ======================================================
 START JOB
====================================================== */
startBtn.addEventListener("click", startJob);

async function startJob() {
  const wo = woInput.value.trim();
  const tech = techInput.value.trim();

  if (!wo || !tech) {
    setStatus("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å WO ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≤‡∏á", "red");
    return;
  }

  startBtn.disabled = true;
  setStatus("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô...");

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({
        mode: "technician",
        action: "START_JOB",
        wo_no: wo,
        technician: tech
      })
    }).then(r => r.json());

    if (res.status === "STARTED") {
      unlockForFinish();
      setStatus("üü° ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß", "#ca8a04");
    } else {
      setStatus("‚ùå " + (res.error || "Start ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"), "red");
      startBtn.disabled = false;
    }

  } catch (err) {
    setStatus("‚ùå Network error", "red");
    startBtn.disabled = false;
  }
}

/* ======================================================
 FINISH JOB
====================================================== */
finishBtn.addEventListener("click", finishJob);

async function finishJob() {
  const wo = woInput.value.trim();
  const detail = detailInput.value.trim();

  if (!detail) {
    setStatus("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°", "red");
    return;
  }

  if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ")) {
    return;
  }

  finishBtn.disabled = true;
  setStatus("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô...");

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({
        mode: "technician",
        action: "FINISH_JOB",
        wo_no: wo,
        fix_detail: detail
      })
    }).then(r => r.json());

    if (res.status === "FINISHED") {
      lockAll();
      setStatus("‚úÖ ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß", "green");

      setTimeout(() => {
        if (confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö Work Order ‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
          resetForm();
        }
      }, 500);

    } else {
      setStatus("‚ùå " + (res.error || "Finish ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"), "red");
      finishBtn.disabled = false;
    }

  } catch (err) {
    setStatus("‚ùå Network error", "red");
    finishBtn.disabled = false;
  }
}
</script>

</body>
</html>

